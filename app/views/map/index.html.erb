<% content_for :stylesheet_includes do %>
	<style type="text/css">
		body{ background-color: black; }
		.container { width:100%; padding:0;}
		#map-canvas { height:550px; width:100%; top:10px; }
		#map-details { height:auto; width:100%; }
	</style>
<% end %>
<% content_for :javascript_includes do %>
	<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=<%= GOOGLE_MAP_API_KEY %>&sensor=true"></script>
	<script type="text/javascript">
    var map;
    var place_ids_on_the_map = new Array();
    var markers = new Array();
    
    function initialize() {
      var mapOptions = {
        zoom: 4,
        center: new google.maps.LatLng(0,0),
        mapTypeId: google.maps.MapTypeId.HYBRID
      }
      map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

      <% @places_first_level.each do |p| %>
        <% if p.children_places.exists? %>
          var array_of_childs = new Array();
          <% p.children_places.each do |c| %>
            array_of_childs.push(new Array(<%= c.id %>, "<%= c.name %>", <%= c.lat %>, <%= c.lon %>, <%= c.place_type_id %>));
          <% end %>
          createMarker(<%= p.id %>, "<%= p.name %>", <%= p.lat %>, <%= p.lon %>, <%= p.place_type_id %>, array_of_childs);
        <% else %>
          createMarker(<%= p.id %>, "<%= p.name %>", <%= p.lat %>, <%= p.lon %>, <%= p.place_type_id %>);
        <% end %>
      <% end %>
      
    }

    function setDetailsContent(id){
      alert("afficher les details de la place avec l'id : " + id);
    }

    function createMarker(id, name, lat, lon, img_name, children_places){
      if(place_ids_on_the_map.indexOf(id) == -1){
        var myLatLng = new google.maps.LatLng(lat, lon);
        var image = "maps_icons/"+img_name+".png";
        var marker= new google.maps.Marker({
            position: myLatLng, 
            map: map,
            icon: image
        });
        google.maps.event.addListener(marker, "click", function() {
              //disable all pin's animations
              for (var i = 0; i < markers.length; i++) {
                if (markers[i].getAnimation() != null) {
                  markers[i].setAnimation(null);
                }
              }

              //annimate the pin
              marker.setAnimation(google.maps.Animation.BOUNCE);
              

              //show children places
              if(children_places!=null){
                for(i=0;i<children_places.length; i++){
                  createMarker(children_places[i][0], children_places[i][1], children_places[i][2], children_places[i][3], children_places[i][4]);
                }
              }

              setDetailsContent(id);
        });
        markers.push(marker);
        place_ids_on_the_map.push(id);
      }
      
    }

    google.maps.event.addDomListener(window, 'load', initialize);
    
	</script>
<% end %>


<div id="map-canvas"></div>
<div id="map-details"></div>